<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Wood Builder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            overflow: hidden;
            background: #1a1a1a;
            color: #fff;
        }
        
        #canvas-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        /* UI Panels */
        .panel {
            position: absolute;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }
        
        #material-panel {
            top: 20px;
            left: 20px;
            width: 300px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        #project-panel {
            top: 20px;
            right: 20px;
            width: 250px;
        }
        
        #info-panel {
            bottom: 20px;
            left: 20px;
            min-width: 200px;
        }
        
        #hotbar {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }
        
        .hotbar-item {
            background: rgba(50, 50, 50, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 8px 12px;
            min-width: 80px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .hotbar-item:hover {
            background: rgba(70, 70, 70, 0.9);
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        .hotbar-key {
            display: block;
            font-size: 10px;
            color: #aaa;
            margin-top: 2px;
        }
        
        /* Material Selection */
        .thickness-group {
            margin-bottom: 15px;
        }
        
        .thickness-header {
            font-weight: bold;
            color: #4a9eff;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .thickness-header:hover {
            color: #6bb4ff;
        }
        
        .material-list {
            display: none;
            padding-left: 10px;
        }
        
        .material-list.active {
            display: block;
        }
        
        .material-item {
            padding: 6px 10px;
            margin: 3px 0;
            background: rgba(60, 60, 60, 0.5);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .material-item:hover {
            background: rgba(80, 80, 80, 0.7);
            transform: translateX(5px);
        }
        
        .material-item.selected {
            background: rgba(74, 158, 255, 0.3);
            border: 1px solid #4a9eff;
        }
        
        /* Length Input */
        #length-input {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        input[type="number"] {
            width: 100%;
            padding: 8px;
            background: rgba(50, 50, 50, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 4px;
            margin-top: 5px;
        }
        
        button {
            background: #4a9eff;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #6bb4ff;
            transform: translateY(-1px);
        }
        
        /* Project Management */
        .project-item {
            padding: 8px;
            margin: 5px 0;
            background: rgba(60, 60, 60, 0.5);
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .project-item.active {
            background: rgba(74, 158, 255, 0.3);
            border: 1px solid #4a9eff;
        }
        
        /* Tooltips */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
        }
        
        /* Measurement Lines */
        .measurement-line {
            position: absolute;
            background: #4a9eff;
            pointer-events: none;
            opacity: 0.6;
        }
        
        .measurement-text {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: #4a9eff;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 11px;
            pointer-events: none;
        }
        
        /* Mode Indicator */
        #mode-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(74, 158, 255, 0.2);
            border: 2px solid #4a9eff;
            padding: 20px 40px;
            border-radius: 8px;
            font-size: 24px;
            font-weight: bold;
            display: none;
            pointer-events: none;
        }
        
        /* Controls Help */
        #controls-help {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(30, 30, 30, 0.95);
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.6;
            max-width: 300px;
        }
        
        #controls-help h4 {
            margin-bottom: 10px;
            color: #4a9eff;
        }
        
        #controls-help kbd {
            background: rgba(60, 60, 60, 0.8);
            padding: 2px 6px;
            border-radius: 3px;
            margin: 0 2px;
        }
        
        /* Material List */
        #material-list {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .material-summary {
            margin: 10px 0;
            padding: 10px;
            background: rgba(50, 50, 50, 0.5);
            border-radius: 4px;
        }
        
        .material-summary h4 {
            color: #4a9eff;
            margin-bottom: 5px;
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(30, 30, 30, 0.5);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(100, 100, 100, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(120, 120, 120, 0.7);
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    
    <!-- Material Selection Panel -->
    <div id="material-panel" class="panel">
        <h3>Velg Materiale</h3>
        <div id="material-categories"></div>
        <div id="length-input">
            <label>Lengde (mm):</label>
            <input type="number" id="length" value="2400" min="100" max="6000" step="100">
            <button onclick="app.createPiece()">Lag Planke</button>
        </div>
        <div id="material-list">
            <h4>Materialliste</h4>
            <div id="material-summary"></div>
        </div>
    </div>
    
    <!-- Project Panel -->
    <div id="project-panel" class="panel">
        <h3>Prosjekter</h3>
        <input type="text" id="new-project-name" placeholder="Nytt prosjekt navn...">
        <button onclick="app.createProject()">Lag Prosjekt</button>
        <div id="project-list" style="margin-top: 15px;"></div>
        <div style="margin-top: 15px;">
            <button onclick="app.undo()">↶ Angre</button>
            <button onclick="app.redo()">↷ Gjør om</button>
        </div>
    </div>
    
    <!-- Info Panel -->
    <div id="info-panel" class="panel">
        <div id="info-content">
            <div>Valgt: <span id="selected-material">Ingen</span></div>
            <div>Modus: <span id="current-mode">Normal</span></div>
            <div>Antall planker: <span id="piece-count">0</span></div>
        </div>
    </div>
    
    <!-- Hotbar -->
    <div id="hotbar" class="panel">
        <div class="hotbar-item" data-key="1">
            <span class="dimension">Tom</span>
            <span class="hotbar-key">1</span>
        </div>
        <div class="hotbar-item" data-key="2">
            <span class="dimension">Tom</span>
            <span class="hotbar-key">2</span>
        </div>
        <div class="hotbar-item" data-key="3">
            <span class="dimension">Tom</span>
            <span class="hotbar-key">3</span>
        </div>
        <div class="hotbar-item" data-key="4">
            <span class="dimension">Tom</span>
            <span class="hotbar-key">4</span>
        </div>
        <div class="hotbar-item" data-key="5">
            <span class="dimension">Tom</span>
            <span class="hotbar-key">5</span>
        </div>
    </div>
    
    <!-- Mode Indicator -->
    <div id="mode-indicator"></div>
    
    <!-- Controls Help -->
    <div id="controls-help">
        <h4>Kontroller</h4>
        <div><kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd> - Naviger</div>
        <div><kbd>Hold R</kbd> - Roter modus</div>
        <div><kbd>Hold V</kbd> - Vertikal bevegelse</div>
        <div><kbd>Hold T + Klikk</kbd> - Slett planke</div>
        <div><kbd>Hold F + Dra</kbd> - Juster lengde</div>
        <div><kbd>1-5</kbd> - Rask tilgang</div>
        <div><kbd>Backspace</kbd> - Avbryt plassering</div>
        <div><kbd>Scroll</kbd> - Zoom</div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Main Application
        class WoodBuilderApp {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.raycaster = new THREE.Raycaster();
                this.mouse = new THREE.Vector2();
                
                // State
                this.selectedMaterial = null;
                this.activePiece = null;
                this.pieces = [];
                this.mode = 'normal'; // normal, rotate, vertical, delete, length
                this.isPlacing = false;
                this.isDragging = false;
                
                // Projects
                this.projects = {};
                this.currentProject = null;
                this.history = [];
                this.historyIndex = -1;
                
                // Materials database
                this.materials = {
                    20: [
                        { thickness: 20, width: 120, name: "20x120 mm" }
                    ],
                    28: [
                        { thickness: 28, width: 120, name: "28x120 mm" }
                    ],
                    36: [
                        { thickness: 36, width: 48, name: "36x48 mm" },
                        { thickness: 36, width: 98, name: "36x98 mm" }
                    ],
                    48: [
                        { thickness: 48, width: 48, name: "48x48 mm" },
                        { thickness: 48, width: 73, name: "48x73 mm" },
                        { thickness: 48, width: 98, name: "48x98 mm" },
                        { thickness: 48, width: 148, name: "48x148 mm" },
                        { thickness: 48, width: 198, name: "48x198 mm" }
                    ],
                    98: [
                        { thickness: 98, width: 98, name: "98x98 mm" }
                    ]
                };
                
                // Recently used dimensions
                this.recentDimensions = [];
                
                // Movement constraints
                this.gridSize = 10; // mm
                this.rotationSnap = Math.PI / 12; // 15 degrees
                
                // Keys state
                this.keys = {};
                
                this.init();
            }
            
            init() {
                this.setupScene();
                this.setupLights();
                this.setupGround();
                this.setupControls();
                this.setupUI();
                this.loadProjects();
                this.animate();
            }
            
            setupScene() {
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x222222);
                this.scene.fog = new THREE.Fog(0x222222, 1000, 10000);
                
                this.camera = new THREE.PerspectiveCamera(
                    60,
                    window.innerWidth / window.innerHeight,
                    1,
                    10000
                );
                this.camera.position.set(2000, 1500, 2000);
                this.camera.lookAt(0, 0, 0);
                
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                document.getElementById('canvas-container').appendChild(this.renderer.domElement);
                
                window.addEventListener('resize', () => this.onResize());
            }
            
            setupLights() {
                const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
                this.scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                directionalLight.position.set(1000, 2000, 1000);
                directionalLight.castShadow = true;
                directionalLight.shadow.camera.left = -3000;
                directionalLight.shadow.camera.right = 3000;
                directionalLight.shadow.camera.top = 3000;
                directionalLight.shadow.camera.bottom = -3000;
                directionalLight.shadow.camera.near = 100;
                directionalLight.shadow.camera.far = 5000;
                directionalLight.shadow.mapSize.width = 2048;
                directionalLight.shadow.mapSize.height = 2048;
                this.scene.add(directionalLight);
            }
            
            setupGround() {
                const groundGeometry = new THREE.PlaneGeometry(10000, 10000);
                const groundMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0x333333,
                    depthWrite: false
                });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                ground.receiveShadow = true;
                ground.name = 'ground';
                this.scene.add(ground);
                
                // Grid
                const gridHelper = new THREE.GridHelper(10000, 100, 0x444444, 0x444444);
                this.scene.add(gridHelper);
            }
            
            setupControls() {
                // Mouse events
                this.renderer.domElement.addEventListener('mousemove', (e) => this.onMouseMove(e));
                this.renderer.domElement.addEventListener('mousedown', (e) => this.onMouseDown(e));
                this.renderer.domElement.addEventListener('mouseup', (e) => this.onMouseUp(e));
                this.renderer.domElement.addEventListener('wheel', (e) => this.onWheel(e));
                
                // Keyboard events
                window.addEventListener('keydown', (e) => this.onKeyDown(e));
                window.addEventListener('keyup', (e) => this.onKeyUp(e));
            }
            
            setupUI() {
                // Generate material categories
                const categoriesDiv = document.getElementById('material-categories');
                Object.entries(this.materials).forEach(([thickness, items]) => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'thickness-group';
                    
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'thickness-header';
                    headerDiv.innerHTML = `
                        <span>${thickness}mm tykkelse</span>
                        <span>▼</span>
                    `;
                    headerDiv.onclick = () => {
                        const list = groupDiv.querySelector('.material-list');
                        list.classList.toggle('active');
                        headerDiv.querySelector('span:last-child').textContent = 
                            list.classList.contains('active') ? '▲' : '▼';
                    };
                    
                    const listDiv = document.createElement('div');
                    listDiv.className = 'material-list';
                    
                    items.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'material-item';
                        itemDiv.textContent = item.name;
                        itemDiv.onclick = () => this.selectMaterial(item);
                        listDiv.appendChild(itemDiv);
                    });
                    
                    groupDiv.appendChild(headerDiv);
                    groupDiv.appendChild(listDiv);
                    categoriesDiv.appendChild(groupDiv);
                });
                
                // Update hotbar click handlers
                document.querySelectorAll('.hotbar-item').forEach(item => {
                    item.onclick = () => {
                        const key = item.dataset.key;
                        const index = parseInt(key) - 1;
                        if (this.recentDimensions[index]) {
                            this.selectMaterial(this.recentDimensions[index]);
                            document.getElementById('length').value = this.recentDimensions[index].lastLength || 2400;
                        }
                    };
                });
            }
            
            selectMaterial(material) {
                this.selectedMaterial = material;
                
                // Update UI
                document.querySelectorAll('.material-item').forEach(item => {
                    item.classList.remove('selected');
                    if (item.textContent === material.name) {
                        item.classList.add('selected');
                    }
                });
                
                document.getElementById('selected-material').textContent = material.name;
                
                // Update recent dimensions
                const existingIndex = this.recentDimensions.findIndex(
                    m => m.thickness === material.thickness && m.width === material.width
                );
                if (existingIndex !== -1) {
                    this.recentDimensions.splice(existingIndex, 1);
                }
                this.recentDimensions.unshift(material);
                this.recentDimensions = this.recentDimensions.slice(0, 5);
                
                this.updateHotbar();
            }
            
            updateHotbar() {
                document.querySelectorAll('.hotbar-item').forEach((item, index) => {
                    const dimensionSpan = item.querySelector('.dimension');
                    if (this.recentDimensions[index]) {
                        dimensionSpan.textContent = this.recentDimensions[index].name;
                    } else {
                        dimensionSpan.textContent = 'Tom';
                    }
                });
            }
            
            createPiece() {
                if (!this.selectedMaterial) {
                    alert('Velg et materiale først!');
                    return;
                }
                
                const length = parseFloat(document.getElementById('length').value);
                if (length < 100 || length > 6000) {
                    alert('Lengde må være mellom 100mm og 6000mm');
                    return;
                }
                
                // Store last used length
                this.selectedMaterial.lastLength = length;
                
                // Create wood piece
                const geometry = new THREE.BoxGeometry(
                    this.selectedMaterial.thickness,
                    this.selectedMaterial.width,
                    length
                );
                
                const material = new THREE.MeshPhongMaterial({
                    color: 0x8B4513,
                    flatShading: false
                });
                
                const piece = new THREE.Mesh(geometry, material);
                piece.castShadow = true;
                piece.receiveShadow = true;
                
                // Set initial position
                piece.position.set(0, this.selectedMaterial.width / 2, 0);
                
                // Add metadata
                piece.userData = {
                    thickness: this.selectedMaterial.thickness,
                    width: this.selectedMaterial.width,
                    length: length,
                    material: this.selectedMaterial.name,
                    isActive: true
                };
                
                this.scene.add(piece);
                this.activePiece = piece;
                this.isPlacing = true;
                
                this.updateInfo();
            }
            
            onMouseMove(event) {
                // Update mouse position
                this.mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                this.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
                
                if (this.activePiece && this.isPlacing) {
                    this.updateActivePiecePosition();
                }
                
                // Handle drag operations
                if (this.isDragging && this.selectedPiece) {
                    this.handleDragOperation(event);
                }
            }
            
            updateActivePiecePosition() {
                this.raycaster.setFromCamera(this.mouse, this.camera);
                
                // Create a plane at the current height
                const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), -this.activePiece.position.y);
                const intersection = new THREE.Vector3();
                this.raycaster.ray.intersectPlane(plane, intersection);
                
                if (intersection) {
                    // Snap to grid
                    intersection.x = Math.round(intersection.x / this.gridSize) * this.gridSize;
                    intersection.z = Math.round(intersection.z / this.gridSize) * this.gridSize;
                    
                    this.activePiece.position.x = intersection.x;
                    this.activePiece.position.z = intersection.z;
                    
                    // Show distance measurements
                    this.showMeasurements(this.activePiece);
                }
            }
            
            showMeasurements(piece) {
                // This would show distance lines to nearest objects
                // For now, we'll just update the info panel
                const distances = this.calculateDistances(piece);
                // TODO: Render measurement lines in 3D
            }
            
            calculateDistances(piece) {
                const distances = {
                    floor: piece.position.y - piece.userData.width / 2,
                    nearest: Infinity
                };
                
                // Find nearest piece
                this.pieces.forEach(other => {
                    if (other !== piece) {
                        const dist = piece.position.distanceTo(other.position);
                        if (dist < distances.nearest) {
                            distances.nearest = dist;
                        }
                    }
                });
                
                return distances;
            }
            
            onMouseDown(event) {
                if (this.activePiece && this.isPlacing) {
                    return; // Don't handle other clicks while placing
                }
                
                // Check for piece selection
                this.raycaster.setFromCamera(this.mouse, this.camera);
                const intersects = this.raycaster.intersectObjects(this.pieces);
                
                if (intersects.length > 0) {
                    this.selectedPiece = intersects[0].object;
                    
                    if (this.keys['t']) {
                        // Delete mode
                        this.deletePiece(this.selectedPiece);
                    } else if (this.keys['f']) {
                        // Length adjustment mode
                        this.startLengthAdjustment(event);
                    } else {
                        // Start dragging
                        this.isDragging = true;
                        this.dragStart = { x: event.clientX, y: event.clientY };
                    }
                }
            }
            
            onMouseUp(event) {
                if (this.activePiece && this.isPlacing) {
                    // Place the piece
                    this.activePiece.userData.isActive = false;
                    this.pieces.push(this.activePiece);
                    this.activePiece = null;
                    this.isPlacing = false;
                    
                    this.saveState();
                    this.updateInfo();
                    this.updateMaterialList();
                    return;
                }
                
                this.isDragging = false;
                this.selectedPiece = null;
            }
            
            onKeyDown(event) {
                this.keys[event.key.toLowerCase()] = true;
                
                // Mode indicators
                if (event.key === 'r') {
                    this.showMode('ROTER MODUS');
                } else if (event.key === 'v') {
                    this.showMode('VERTIKAL MODUS');
                } else if (event.key === 't') {
                    this.showMode('SLETT MODUS');
                } else if (event.key === 'f') {
                    this.showMode('LENGDE JUSTERING');
                }
                
                // Cancel placement
                if (event.key === 'Backspace' && this.activePiece) {
                    this.scene.remove(this.activePiece);
                    this.activePiece = null;
                    this.isPlacing = false;
                }
                
                // Number keys for hotbar
                if (event.key >= '1' && event.key <= '5') {
                    const index = parseInt(event.key) - 1;
                    if (this.recentDimensions[index]) {
                        this.selectMaterial(this.recentDimensions[index]);
                        const lastLength = this.recentDimensions[index].lastLength || 2400;
                        document.getElementById('length').value = lastLength;
                    }
                }
                
                // Camera movement
                this.handleCameraMovement();
            }
            
            onKeyUp(event) {
                this.keys[event.key.toLowerCase()] = false;
                
                // Hide mode indicator
                if (['r', 'v', 't', 'f'].includes(event.key)) {
                    this.hideMode();
                }
            }
            
            showMode(text) {
                const indicator = document.getElementById('mode-indicator');
                indicator.textContent = text;
                indicator.style.display = 'block';
            }
            
            hideMode() {
                document.getElementById('mode-indicator').style.display = 'none';
            }
            
            handleCameraMovement() {
                const speed = 50;
                const moveVector = new THREE.Vector3();
                
                if (this.keys['w']) moveVector.z -= speed;
                if (this.keys['s']) moveVector.z += speed;
                if (this.keys['a']) moveVector.x -= speed;
                if (this.keys['d']) moveVector.x += speed;
                
                // Apply camera rotation to movement
                moveVector.applyQuaternion(this.camera.quaternion);
                moveVector.y = 0; // Keep movement horizontal
                
                this.camera.position.add(moveVector);
            }
            
            onWheel(event) {
                const zoomSpeed = 0.1;
                const direction = event.deltaY > 0 ? 1 : -1;
                const distance = this.camera.position.length();
                
                this.camera.position.multiplyScalar(1 + direction * zoomSpeed);
                
                event.preventDefault();
            }
            
            handleDragOperation(event) {
                if (!this.selectedPiece) return;
                
                const deltaX = event.clientX - this.dragStart.x;
                const deltaY = event.clientY - this.dragStart.y;
                
                if (this.keys['r']) {
                    // Rotation mode
                    if (event.buttons === 1) {
                        // Left click - horizontal rotation
                        this.selectedPiece.rotation.y += deltaX * 0.01;
                    } else if (event.buttons === 2) {
                        // Right click - vertical rotation
                        this.selectedPiece.rotation.x += deltaY * 0.01;
                    }
                } else if (this.keys['v']) {
                    // Vertical movement
                    this.selectedPiece.position.y += -deltaY;
                } else {
                    // Normal movement
                    const moveSpeed = 1;
                    this.selectedPiece.position.x += deltaX * moveSpeed;
                    this.selectedPiece.position.z += deltaY * moveSpeed;
                }
                
                this.dragStart = { x: event.clientX, y: event.clientY };
            }
            
            deletePiece(piece) {
                const index = this.pieces.indexOf(piece);
                if (index !== -1) {
                    this.pieces.splice(index, 1);
                    this.scene.remove(piece);
                    this.saveState();
                    this.updateInfo();
                    this.updateMaterialList();
                }
            }
            
            updateInfo() {
                document.getElementById('piece-count').textContent = this.pieces.length;
                document.getElementById('current-mode').textContent = 
                    this.isPlacing ? 'Plasserer' : 'Normal';
            }
            
            updateMaterialList() {
                const summary = {};
                
                this.pieces.forEach(piece => {
                    const key = piece.userData.material;
                    const length = piece.userData.length;
                    
                    if (!summary[key]) {
                        summary[key] = {
                            count: 0,
                            totalLength: 0,
                            lengths: {}
                        };
                    }
                    
                    summary[key].count++;
                    summary[key].totalLength += length;
                    
                    if (!summary[key].lengths[length]) {
                        summary[key].lengths[length] = 0;
                    }
                    summary[key].lengths[length]++;
                });
                
                // Update UI
                const summaryDiv = document.getElementById('material-summary');
                summaryDiv.innerHTML = '';
                
                Object.entries(summary).forEach(([material, data]) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'material-summary';
                    
                    let lengthsText = Object.entries(data.lengths)
                        .map(([len, count]) => `${count}x ${len}mm`)
                        .join(', ');
                    
                    itemDiv.innerHTML = `
                        <h4>${material}</h4>
                        <div>Antall: ${data.count} stk</div>
                        <div>Total lengde: ${(data.totalLength / 1000).toFixed(1)} m</div>
                        <div>Lengder: ${lengthsText}</div>
                    `;
                    
                    summaryDiv.appendChild(itemDiv);
                });
            }
            
            // Project Management
            createProject() {
                const name = document.getElementById('new-project-name').value.trim();
                if (!name) {
                    alert('Gi prosjektet et navn!');
                    return;
                }
                
                const projectId = Date.now().toString();
                this.projects[projectId] = {
                    id: projectId,
                    name: name,
                    created: new Date().toISOString(),
                    data: {
                        pieces: [],
                        camera: {
                            position: this.camera.position.toArray(),
                            rotation: this.camera.rotation.toArray()
                        }
                    }
                };
                
                this.switchProject(projectId);
                document.getElementById('new-project-name').value = '';
            }
            
            switchProject(projectId) {
                // Save current project
                if (this.currentProject) {
                    this.saveProject();
                }
                
                // Clear scene
                this.pieces.forEach(piece => this.scene.remove(piece));
                this.pieces = [];
                this.history = [];
                this.historyIndex = -1;
                
                // Load new project
                this.currentProject = projectId;
                const project = this.projects[projectId];
                
                if (project.data.pieces) {
                    project.data.pieces.forEach(pieceData => {
                        this.loadPiece(pieceData);
                    });
                }
                
                if (project.data.camera) {
                    this.camera.position.fromArray(project.data.camera.position);
                    this.camera.rotation.fromArray(project.data.camera.rotation);
                }
                
                this.updateProjectList();
                this.updateInfo();
                this.updateMaterialList();
            }
            
            loadPiece(pieceData) {
                const geometry = new THREE.BoxGeometry(
                    pieceData.thickness,
                    pieceData.width,
                    pieceData.length
                );
                
                const material = new THREE.MeshPhongMaterial({
                    color: 0x8B4513
                });
                
                const piece = new THREE.Mesh(geometry, material);
                piece.castShadow = true;
                piece.receiveShadow = true;
                
                piece.position.fromArray(pieceData.position);
                piece.rotation.fromArray(pieceData.rotation);
                piece.userData = {
                    thickness: pieceData.thickness,
                    width: pieceData.width,
                    length: pieceData.length,
                    material: pieceData.material,
                    isActive: false
                };
                
                this.scene.add(piece);
                this.pieces.push(piece);
            }
            
            saveProject() {
                if (!this.currentProject) return;
                
                const pieceData = this.pieces.map(piece => ({
                    thickness: piece.userData.thickness,
                    width: piece.userData.width,
                    length: piece.userData.length,
                    material: piece.userData.material,
                    position: piece.position.toArray(),
                    rotation: piece.rotation.toArray()
                }));
                
                this.projects[this.currentProject].data = {
                    pieces: pieceData,
                    camera: {
                        position: this.camera.position.toArray(),
                        rotation: this.camera.rotation.toArray()
                    }
                };
                
                this.saveToStorage();
            }
            
            saveToStorage() {
                localStorage.setItem('woodBuilderProjects', JSON.stringify(this.projects));
            }
            
            loadProjects() {
                const saved = localStorage.getItem('woodBuilderProjects');
                if (saved) {
                    this.projects = JSON.parse(saved);
                    this.updateProjectList();
                }
            }
            
            updateProjectList() {
                const listDiv = document.getElementById('project-list');
                listDiv.innerHTML = '';
                
                Object.values(this.projects).forEach(project => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'project-item';
                    if (project.id === this.currentProject) {
                        itemDiv.classList.add('active');
                    }
                    
                    itemDiv.innerHTML = `
                        <span>${project.name}</span>
                        <div>
                            <button onclick="app.switchProject('${project.id}')">Åpne</button>
                            <button onclick="app.deleteProject('${project.id}')">Slett</button>
                        </div>
                    `;
                    
                    listDiv.appendChild(itemDiv);
                });
            }
            
            deleteProject(projectId) {
                if (confirm('Er du sikker på at du vil slette dette prosjektet?')) {
                    delete this.projects[projectId];
                    
                    if (projectId === this.currentProject) {
                        this.currentProject = null;
                        this.pieces.forEach(piece => this.scene.remove(piece));
                        this.pieces = [];
                    }
                    
                    this.saveToStorage();
                    this.updateProjectList();
                    this.updateInfo();
                }
            }
            
            // Undo/Redo
            saveState() {
                if (!this.currentProject) return;
                
                const state = {
                    pieces: this.pieces.map(piece => ({
                        thickness: piece.userData.thickness,
                        width: piece.userData.width,
                        length: piece.userData.length,
                        material: piece.userData.material,
                        position: piece.position.toArray(),
                        rotation: piece.rotation.toArray()
                    }))
                };
                
                // Remove any states after current index
                this.history = this.history.slice(0, this.historyIndex + 1);
                
                // Add new state
                this.history.push(state);
                this.historyIndex++;
                
                // Limit history size
                if (this.history.length > 50) {
                    this.history.shift();
                    this.historyIndex--;
                }
                
                // Auto-save project
                this.saveProject();
            }
            
            undo() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    this.loadState(this.history[this.historyIndex]);
                }
            }
            
            redo() {
                if (this.historyIndex < this.history.length - 1) {
                    this.historyIndex++;
                    this.loadState(this.history[this.historyIndex]);
                }
            }
            
            loadState(state) {
                // Clear current pieces
                this.pieces.forEach(piece => this.scene.remove(piece));
                this.pieces = [];
                
                // Load pieces from state
                state.pieces.forEach(pieceData => {
                    this.loadPiece(pieceData);
                });
                
                this.updateInfo();
                this.updateMaterialList();
            }
            
            onResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            animate() {
                requestAnimationFrame(() => this.animate());
                
                // Handle continuous key actions
                if (Object.keys(this.keys).some(key => this.keys[key])) {
                    this.handleCameraMovement();
                }
                
                this.renderer.render(this.scene, this.camera);
            }
        }
        
        // Initialize application
        const app = new WoodBuilderApp();
        
        // Prevent right-click context menu on canvas
        document.addEventListener('contextmenu', (e) => {
            if (e.target.tagName === 'CANVAS') {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
